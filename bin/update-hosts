#!/usr/bin/env bash

hosts_site='https://someonewhocares.org/hosts/zero/hosts'
hosts_orig="/etc/hosts"

# temp files
hosts_temp="$HOME/Desktop/.temp-hosts-temp-$(date +'%Y%m%d%H%M%S')"
hosts_zero="$HOME/Desktop/.temp-hosts-zero-$(date +'%Y%m%d%H%M%S')"
hosts_fine="$HOME/Desktop/.temp-hosts-fine-$(date +'%Y%m%d%H%M%S')"
trap "$(which rm) -rf $hosts_temp $hosts_zero $hosts_fine" EXIT ERR

# message
message () {
	local textbf; textbf=$(tput bold)
	local textrm; textrm=$(tput sgr0)
	echo "${textbf}$(basename $0)${textrm}: $1" ;
}

# run as root
[[ $(id -u) != 0 ]] && {
	message "please run as root." >&2
	exit 1
}

# check if "### AD-BLOCK" line is present in "/etc/hosts".
grep -q "### AD-BLOCK" "$hosts_orig"
[[ $? -ne 0 ]] && {
	message "puting '### AD-BLOCK' line in '$hosts_orig'..."
	sudo printf "\n\n### AD-BLOCK" >> "$hosts_orig"
}

### Main ######################################################################

message "downloading..."
curl -s "$hosts_site" > "$hosts_zero"
[[ ! -f "$hosts_zero" ]] && { message "curl failed" >&2 ; exit 1 ; }
message "downloaded"

message "modifying..."
ed_command="/^### AD-BLOCK\nc\n### AD-BLOCK ( $(date +'%F %X') )\n.\n.+2,\$d\nwq\n"
cp "$hosts_orig" "$hosts_temp"
printf "$ed_command" | ed -s "$hosts_temp" > /dev/null
cat "$hosts_temp" "$hosts_zero" > "$hosts_fine"
message "new hosts created"

message "moving and changing permission..."
mv "$hosts_fine" "$hosts_orig"
chmod 644 "$hosts_orig"
message "finished"

exit 0
